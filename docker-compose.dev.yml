# =============================================================================
# Fantasy World RAG - Development Docker Compose
# =============================================================================
# Optimized for local development with hot-reloading
# Usage: docker-compose -f docker-compose.dev.yml up
# =============================================================================

version: '3.8'

services:
  # ===========================================================================
  # Development API (with hot-reload)
  # ===========================================================================
  api-dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    container_name: fantasy-world-api-dev
    ports:
      - "8000:8000"
    environment:
      - APP_ENV=development
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      - DATABASE_URL=postgresql+asyncpg://fantasy_user:fantasy_password@postgres:5432/fantasy_world
      - REDIS_URL=redis://redis:6379/0
      - QDRANT_URL=http://qdrant:6333
    volumes:
      - ./src:/app/src
      - ./data:/app/data
      - ./tests:/app/tests
      - ./scripts:/app/scripts
    command: uvicorn src.api.app:create_app --host 0.0.0.0 --port 8000 --reload --factory
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - fantasy-dev-network
    restart: unless-stopped

  # ===========================================================================
  # PostgreSQL (Development)
  # ===========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: fantasy-postgres-dev
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: fantasy_world
      POSTGRES_USER: fantasy_user
      POSTGRES_PASSWORD: fantasy_password
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
    networks:
      - fantasy-dev-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fantasy_user -d fantasy_world"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # Redis (Development)
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: fantasy-redis-dev
    ports:
      - "6379:6379"
    networks:
      - fantasy-dev-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # Qdrant Vector DB (Development)
  # ===========================================================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: fantasy-qdrant-dev
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_dev_data:/qdrant/storage
    networks:
      - fantasy-dev-network

  # ===========================================================================
  # pgAdmin (Database GUI)
  # ===========================================================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: fantasy-pgadmin
    ports:
      - "5050:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@fantasy.local
      PGADMIN_DEFAULT_PASSWORD: admin
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - fantasy-dev-network
    depends_on:
      - postgres

  # ===========================================================================
  # Redis Commander (Redis GUI)
  # ===========================================================================
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: fantasy-redis-commander
    ports:
      - "8081:8081"
    environment:
      REDIS_HOSTS: local:redis:6379
    networks:
      - fantasy-dev-network
    depends_on:
      - redis

networks:
  fantasy-dev-network:
    driver: bridge

volumes:
  postgres_dev_data:
  qdrant_dev_data:
  pgadmin_data:
